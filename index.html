<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>WhatsApp Business API Dashboard</title>
    <style>
        /* Paste all the CSS from the WhatsApp Business API Dashboard plugin here */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Main container should not be flex if you want sidebar to scroll with page */
        .whatsapp-dashboard-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            border-radius: 12px;
            width: 280px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            padding: 0;
            height: 40vh;
            overflow-y: auto;
            float: left;
        }

        /* Rest of the CSS from the plugin */
        /* ... */
    </style>
</head>

<body>
    <!-- WhatsApp Business API Dashboard HTML -->
    <div class="whatsapp-dashboard-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>WhatsApp Business</h2>
                <p>API Dashboard</p>
            </div>
            <ul class="sidebar-nav">
                <li>
                    <a href="#" class="nav-link active" data-page="phone-numbers">
                        Phone Numbers
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-page="templates">
                        Template Names
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-page="analytics">
                        Template Analytics
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-page="billing">
                        Billing Information
                    </a>
                </li>
            </ul>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Header -->
            <div class="top-header">
                <h1 class="page-title" id="currentPageTitle">Phone Numbers</h1>
                <div class="header-actions">
                    <button class="btn" onclick="loadDashboardData()">
                        Refresh Data
                    </button>
                </div>
            </div>
            <!-- Hidden inputs for credentials -->
            <input type="hidden" id="wabaId" value="2004058750407284" />
            <input type="hidden" id="accessToken" value="EAASY49jJ8gQBPZAlqYTlvZBuqaFg4bX4UuxPm0BNd2jraGfO32yIdZCyn3fhoDuwjgle7Mtu6QpWTbN1RR4Az1gCdl4uB3CtVZBJ7H1fIwZABEnSduqd82ue3LMZAvilDz5lhdcxUJrhdoArXtdANYqWHuMZBiKLsImpFQ88wqRSIZBFryv6ukhoAtGQUgdvNffT58G7mw9cmo2Gk74Fs3VCWgcnltjkMGqCpF61sXnrUmQu6gZDZD" />
            <div class="content-area">
                <!-- Phone Numbers Section -->
                <div id="phone-numbers-section" class="page-section active">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h2 class="table-title">WhatsApp Phone Numbers</h2>
                            <span class="table-info" id="phoneNumbersCount">Loading...</span>
                        </div>
                        <div id="phoneNumbersResult">
                            <p class="loading">Loading phone numbers from your WhatsApp Business Account...</p>
                        </div>
                    </div>
                </div>
                <!-- Template Names Section -->
                <div id="templates-section" class="page-section">
                    <div class="data-table-container">
                        <div class="table-header">
                            <h2 class="table-title">WhatsApp Message Templates</h2>
                            <span class="table-info" id="templateCount">Loading...</span>
                        </div>
                        <div id="templatesResult">
                            <p class="loading">Loading templates from your WhatsApp Business Account...</p>
                        </div>
                        <div class="pagination">
                            <div class="pagination-info" id="paginationInfo">Showing 1-10 out of 0</div>
                            <div class="pagination-controls">
                                <button class="pagination-btn">1</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Template Analytics Section -->
                <div id="analytics-section" class="page-section">
                    <div class="date-filter-container">
                        <div class="date-filter-options">
                            <label><input type="radio" name="analytics-date-range" value="today" /> Today</label>
                            <label><input type="radio" name="analytics-date-range" value="yesterday" /> Yesterday</label>
                            <label><input type="radio" name="analytics-date-range" value="last-7-days" checked /> Last 7 days</label>
                            <label><input type="radio" name="analytics-date-range" value="last-14-days" /> Last 14 days</label>
                            <label><input type="radio" name="analytics-date-range" value="last-28-days" /> Last 28 days</label>
                            <label><input type="radio" name="analytics-date-range" value="this-month" /> This month</label>
                            <label><input type="radio" name="analytics-date-range" value="this-quarter" /> This quarter</label>
                            <label><input type="radio" name="analytics-date-range" value="custom" /> Custom</label>
                        </div>
                        <div class="custom-date-range" id="customAnalyticsDateRange" style="display: none;">
                            <div class="date-picker-container">
                                <div class="date-input-group">
                                    <label for="analyticsStartDate" class="date-label">From Date</label>
                                    <input type="date" id="analyticsStartDate" />
                                </div>
                                <div class="date-input-group">
                                    <label for="analyticsEndDate" class="date-label">To Date</label>
                                    <input type="date" id="analyticsEndDate" />
                                </div>
                            </div>
                            <button class="btn" onclick="applyCustomAnalyticsDateRange()">Apply</button>
                        </div>
                        <div class="date-range-display">
                            <span id="analyticsDateRangeDisplay">Last 7 days</span>
                        </div>
                    </div>
                    <div class="analytics-cards" id="analyticsCards">
                        <div class="analytics-card">
                            <h3>Total Sent</h3>
                            <div class="analytics-number" id="totalSent">0</div>
                        </div>
                        <div class="analytics-card">
                            <h3>Delivered</h3>
                            <div class="analytics-number" id="totalDelivered">0</div>
                        </div>
                        <div class="analytics-card">
                            <h3>Read Rate</h3>
                            <div class="analytics-number" id="readRate">0%</div>
                        </div>
                        <div class="analytics-card">
                            <h3>Total Templates</h3>
                            <div class="analytics-number" id="totalTemplates">0</div>
                        </div>
                    </div>
                    <div class="data-table-container">
                        <div class="table-header">
                            <h2 class="table-title">Template Performance Analytics</h2>
                        </div>
                        <div id="analyticsResult">
                            <p class="loading">Template analytics will load automatically after templates are loaded.</p>
                        </div>
                    </div>
                </div>
                <!-- Billing Section -->
                <div id="billing-section" class="page-section">
                    <div class="date-filter-container">
                        <div class="date-filter-options">
                            <label><input type="radio" name="date-range" value="today" /> Today</label>
                            <label><input type="radio" name="date-range" value="yesterday" /> Yesterday</label>
                            <label><input type="radio" name="date-range" value="last-7-days" checked /> Last 7 days</label>
                            <label><input type="radio" name="date-range" value="last-14-days" /> Last 14 days</label>
                            <label><input type="radio" name="date-range" value="last-28-days" /> Last 28 days</label>
                            <label><input type="radio" name="date-range" value="this-month" /> This month</label>
                            <label><input type="radio" name="date-range" value="this-quarter" /> This quarter</label>
                            <label><input type="radio" name="date-range" value="custom" /> Custom</label>
                        </div>
                        <div class="custom-date-range" id="customDateRange" style="display: none;">
                            <div class="date-picker-container">
                                <div class="date-input-group">
                                    <label for="startDate" class="date-label">From Date</label>
                                    <input type="date" id="startDate" />
                                </div>
                                <div class="date-input-group">
                                    <label for="endDate" class="date-label">To Date</label>
                                    <input type="date" id="endDate" />
                                </div>
                            </div>
                            <button class="btn" onclick="applyCustomDateRange()">Apply</button>
                        </div>
                        <div class="date-range-display">
                            <span id="dateRangeDisplay">Last 7 days</span>
                        </div>
                    </div>
                    <div class="data-table-container">
                        <div class="table-header">
                            <h2 class="table-title">Billing Information</h2>
                            <span class="table-info" id="billingCount">Loading...</span>
                        </div>
                        <div id="billingResult">
                            <p class="loading">Loading billing information from your WhatsApp Business Account...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Paste all the JavaScript from the WhatsApp Business API Dashboard plugin here
        let templatesData = [];
        let analyticsData = [];

        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Setup navigation
            const navLinks = document.querySelectorAll('.nav-link');
            const pageSections = document.querySelectorAll('.page-section');
            const pageTitle = document.getElementById('currentPageTitle');

            navLinks.forEach(link => {
                link.addEventListener('click', async function(e) {
                    e.preventDefault();
                    // Remove active class from all links and sections
                    navLinks.forEach(l => l.classList.remove('active'));
                    pageSections.forEach(s => s.classList.remove('active'));
                    // Add active class to clicked link
                    this.classList.add('active');
                    // Show corresponding section
                    const targetPage = this.getAttribute('data-page');
                    const targetSection = document.getElementById(targetPage + '-section');
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                    // Update page title
                    if (targetPage === 'templates') {
                        pageTitle.textContent = 'Template Names';
                    } else if (targetPage === 'analytics') {
                        pageTitle.textContent = 'Template Analytics';
                        // Fetch analytics data when the analytics tab is clicked
                        if (templatesData.length > 0) {
                            await fetchAnalytics();
                        }
                    } else if (targetPage === 'phone-numbers') {
                        pageTitle.textContent = 'Phone Numbers';
                        await fetchPhoneNumbers();
                    } else if (targetPage === 'billing') {
                        pageTitle.textContent = 'Billing Information';
                        await fetchBilling();
                    }
                });
            });

            // Load dashboard data automatically if credentials exist
            const wabaId = document.getElementById('wabaId').value;
            const accessToken = document.getElementById('accessToken').value;
            if (wabaId && accessToken) {
                loadDashboardData();
            } else {
                showError('WhatsApp API credentials not found. Please configure them in your settings.');
            }
        });

       // Load dashboard data automatically if credentials exist
                const wabaId = document.getElementById('wabaId').value;
                const accessToken = document.getElementById('accessToken').value;
                if (wabaId && accessToken) {
                    loadDashboardData();
                } else {
                    showError('WhatsApp API credentials not found. Please configure them in your settings.');
                }
            });

            async function loadDashboardData() {
                const wabaId = document.getElementById('wabaId').value;
                const accessToken = document.getElementById('accessToken').value;
                if (!wabaId || !accessToken) {
                    showError('WhatsApp API credentials not configured');
                    return;
                }
                // Load templates first, then analytics, then phone numbers, then billing
                await fetchTemplates();
                if (templatesData.length > 0) {
                    await fetchAnalytics();
                }
                await fetchPhoneNumbers();
                await fetchBilling();
            }

            // Fetch Templates
            async function fetchTemplates() {
                const wabaId = document.getElementById('wabaId').value;
                const accessToken = document.getElementById('accessToken').value;
                const resultDiv = document.getElementById('templatesResult');
                resultDiv.innerHTML = '<p class="loading">Loading templates from your WhatsApp Business Account...</p>';
                try {
                    const response = await fetch(`https://graph.facebook.com/v23.0/${wabaId}/message_templates`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        mode: 'cors'
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                    }
                    const data = await response.json();
                    templatesData = data.data || [];
                    // Update template count
                    document.getElementById('templateCount').textContent = `${templatesData.length} templates found`;
                    document.getElementById('totalTemplates').textContent = templatesData.length;
                    document.getElementById('paginationInfo').textContent = `Showing 1-${Math.min(10, templatesData.length)} out of ${templatesData.length}`;
                    displayTemplates(templatesData);
                } catch (error) {
                    console.error('Error fetching templates:', error);
                    if (error.message === 'Failed to fetch') {
                        showCORSError();
                    } else {
                        showError(`Error loading templates: ${error.message}`);
                    }
                }
            }

            // Display Templates in table format
            function displayTemplates(templates) {
                const resultDiv = document.getElementById('templatesResult');
                if (templates.length === 0) {
                    resultDiv.innerHTML = '<div class="error">No templates found in this WhatsApp Business Account.</div>';
                    return;
                }
                let tableHTML = `
                    <div class="table-scroll-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Template Name</th>
                                    <th>Language</th>
                                    <th>Status</th>
                                    <th>Category</th>
                                    <th>Template ID</th>
                                    <th>Components</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                templates.forEach(template => {
                    const componentTypes = template.components ? template.components.map(c => c.type).join(', ') : 'N/A';
                    const createdDate = template.created_time ? new Date(template.created_time * 1000).toLocaleDateString() : 'N/A';
                    tableHTML += `
                        <tr>
                            <td><strong>${template.name}</strong></td>
                            <td>${template.language}</td>
                            <td><span class="status-badge status-${template.status.toLowerCase()}">${template.status}</span></td>
                            <td>${template.category}</td>
                            <td><code style="font-size: 11px; background: #f1f3f4; padding: 2px 6px; border-radius: 3px;">${template.id}</code></td>
                            <td style="font-size: 12px;">${componentTypes}</td>
                        </tr>
                    `;
                });
                tableHTML += '</tbody></table>';
                resultDiv.innerHTML = tableHTML;
            }

            // Fetch Phone Numbers
            async function fetchPhoneNumbers() {
                const wabaId = document.getElementById('wabaId').value;
                const accessToken = document.getElementById('accessToken').value;
                const resultDiv = document.getElementById('phoneNumbersResult');
                resultDiv.innerHTML = '<p class="loading">Loading phone numbers from your WhatsApp Business Account...</p>';
                try {
                    const response = await fetch(`https://graph.facebook.com/v22.0/${wabaId}/phone_numbers`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        mode: 'cors'
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                    }
                    const data = await response.json();
                    const phoneNumbers = data.data || [];
                    document.getElementById('phoneNumbersCount').textContent = `${phoneNumbers.length} phone numbers found`;
                    displayPhoneNumbers(phoneNumbers);
                } catch (error) {
                    console.error('Error fetching phone numbers:', error);
                    resultDiv.innerHTML = `<div class="error">Error loading phone numbers: ${error.message}</div>`;
                }
            }

            function displayPhoneNumbers(phoneNumbers) {
                const resultDiv = document.getElementById('phoneNumbersResult');
                if (phoneNumbers.length === 0) {
                    resultDiv.innerHTML = '<div class="error">No phone numbers found in this WhatsApp Business Account.</div>';
                    return;
                }
                let tableHTML = `
                    <div class="table-scroll-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Verified Name</th>
                                    <th>Phone Number</th>
                                    <th>Quality Rating</th>
                                    <th>Platform Type</th>
                                    <th>ID</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                phoneNumbers.forEach(phone => {
                    tableHTML += `
                        <tr>
                            <td>${phone.verified_name || 'N/A'}</td>
                            <td>${phone.display_phone_number || 'N/A'}</td>
                            <td>${phone.quality_rating || 'N/A'}</td>
                            <td>${phone.platform_type || 'N/A'}</td>
                            <td><code style="font-size: 11px; background: #f1f3f4; padding: 2px 6px; border-radius: 3px;">${phone.id}</code></td>
                        </tr>
                    `;
                });
                tableHTML += '</tbody></table>';
                resultDiv.innerHTML = tableHTML;
            }

            // Fetch Billing
            async function fetchBilling(startDate, endDate) {
                const wabaId = document.getElementById('wabaId').value;
                const accessToken = document.getElementById('accessToken').value;
                const resultDiv = document.getElementById('billingResult');
                resultDiv.innerHTML = '<p class="loading">Loading billing information from your WhatsApp Business Account...</p>';
                try {
                    const finalStartDate = startDate || Math.floor(Date.now() / 1000) - (30 * 24 * 60 * 60);
                    const finalEndDate = endDate || Math.floor(Date.now() / 1000);
                    const billingUrl = `https://graph.facebook.com/v20.0/${wabaId}/pricing_analytics?start=${finalStartDate}&end=${finalEndDate}&granularity=DAILY&country_codes=["IN"]&metric_types=["VOLUME","COST"]&dimensions=["COUNTRY","PRICING_TYPE","PRICING_CATEGORY"]&access_token=${accessToken}`;
                    const response = await fetch(billingUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        mode: 'cors'
                    });
                    if (!response.ok) {
                        // Handle HTTP 400 errors (e.g., no data for the selected date range)
                        if (response.status === 400) {
                            resultDiv.innerHTML = '<div class="error">There is no billing information for the selected date range.</div>';
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log('Raw API Response:', data); // Log the raw response
                    const billingEntries = data.data || [];
                    if (billingEntries.length === 0) {
                        resultDiv.innerHTML = '<div class="error">There is no billing information for the selected date range.</div>';
                        return;
                    }
                    document.getElementById('billingCount').textContent = `${billingEntries.length} billing entries found`;
                    updateDateRangeDisplay(finalStartDate, finalEndDate);
                    displayBilling(billingEntries);
                } catch (error) {
                    console.error('Error fetching billing information:', error);
                    resultDiv.innerHTML = `<div class="error">Error loading billing information: ${error.message}</div>`;
                }
            }

            function displayBilling(billingData) {
                const resultDiv = document.getElementById('billingResult');
                if (!billingData || billingData.length === 0) {
                    resultDiv.innerHTML = '<div class="error">There is no billing information for the selected date range.</div>';
                    return;
                }
                let tableHTML = `
                    <div class="table-scroll-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Country</th>
                                    <th>Pricing Type</th>
                                    <th>Pricing Category</th>
                                    <th>Volume</th>
                                    <th>Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                billingData.forEach(entry => {
                    if (entry.data_points && entry.data_points.length > 0) {
                        entry.data_points.forEach(point => {
                            const displayDate = point.start ? new Date(point.start * 1000).toLocaleDateString() : 'N/A';
                            const country = 'IN' || 'N/A';
                            const pricingType = point.pricing_type || 'N/A';
                            const pricingCategory = point.pricing_category || 'N/A';
                            const volume = point.volume !== undefined ? point.volume : 'N/A';
                            const cost = point.cost !== undefined ? `$${parseFloat(point.cost).toFixed(4)}` : 'N/A';
                            tableHTML += `
                                <tr>
                                    <td>${displayDate}</td>
                                    <td>${country}</td>
                                    <td>${pricingType}</td>
                                    <td>${pricingCategory}</td>
                                    <td>${volume}</td>
                                    <td>${cost}</td>
                                </tr>
                            `;
                        });
                    }
                });
                tableHTML += '</tbody></table>';
                resultDiv.innerHTML = tableHTML;
            }

            // Set date range for billing
            function setDateRange(range) {
                const now = new Date();
                let startDate, endDate;
                switch (range) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                        break;
                    case 'yesterday':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 0, 0, 0);
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59);
                        break;
                    case 'last-7-days':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'last-14-days':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 14);
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'last-28-days':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 28);
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'this-month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                        break;
                    case 'this-quarter':
                        const currentMonth = now.getMonth();
                        const quarterStartMonth = Math.floor(currentMonth / 3) * 3;
                        startDate = new Date(now.getFullYear(), quarterStartMonth, 1);
                        endDate = new Date(now.getFullYear(), quarterStartMonth + 3, 0);
                        break;
                    case 'custom':
                        return;
                }
                document.getElementById('startDate').valueAsDate = startDate;
                document.getElementById('endDate').valueAsDate = endDate;
                fetchBilling(Math.floor(startDate.getTime() / 1000), Math.floor(endDate.getTime() / 1000));
            }

            // Set date range for analytics
function setAnalyticsDateRange(range) {
    const now = new Date();
    let startDate, endDate;

    switch (range) {
        case 'today':
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
            break;
        case 'yesterday':
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 0, 0, 0);
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59);
            break;
        case 'last-7-days':
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            break;
        case 'last-14-days':
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 14);
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            break;
        case 'last-28-days':
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 28);
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            break;
        case 'this-month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // Use current day, not end of month
            break;
        case 'this-quarter':
            const currentMonth = now.getMonth();
            const quarterStartMonth = Math.floor(currentMonth / 3) * 3;
            startDate = new Date(now.getFullYear(), quarterStartMonth, 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // Use current day, not end of quarter
            break;
        case 'custom':
            return;
    }

    // Ensure endDate does not exceed current time
    if (endDate > now) {
        endDate = now;
    }

    document.getElementById('analyticsStartDate').valueAsDate = startDate;
    document.getElementById('analyticsEndDate').valueAsDate = endDate;
    fetchAnalytics(Math.floor(startDate.getTime() / 1000), Math.floor(endDate.getTime() / 1000));
}
function applyCustomAnalyticsDateRange() {
    const startDateInput = document.getElementById('analyticsStartDate').value;
    const endDateInput = document.getElementById('analyticsEndDate').value;

    if (!validateDateRange(startDateInput, endDateInput)) {
        return;
    }

    const startDate = new Date(startDateInput).getTime() / 1000;
    const endDate = new Date(endDateInput).getTime() / 1000;

    fetchAnalytics(startDate, endDate);
}

            // Update date range display for analytics
            function updateAnalyticsDateRangeDisplay(startDate, endDate) {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                const startDateStr = new Date(startDate * 1000).toLocaleDateString(undefined, options);
                const endDateStr = new Date(endDate * 1000).toLocaleDateString(undefined, options);
                document.getElementById('analyticsDateRangeDisplay').textContent = `${startDateStr} - ${endDateStr}`;
            }

           async function fetchAnalytics(startDate, endDate) {
    const wabaId = document.getElementById('wabaId').value;
    const accessToken = document.getElementById('accessToken').value;
    const analyticsDiv = document.getElementById('analyticsResult');
    analyticsDiv.innerHTML = '<p class="loading">Loading analytics for your templates...</p>';

    try {
        const templateIds = templatesData.map(t => t.id);
        const finalStartDate = startDate || Math.floor(Date.now() / 1000) - (7 * 24 * 60 * 60);
        const finalEndDate = endDate || Math.floor(Date.now() / 1000);

        // Ensure endDate is not in the future
        const now = Math.floor(Date.now() / 1000);
        if (finalEndDate > now) {
            finalEndDate = now;
        }

        const analyticsUrl = `https://graph.facebook.com/v23.0/${wabaId}/template_analytics?start=${finalStartDate}&end=${finalEndDate}&granularity=daily&metric_types=cost,clicked,delivered,read,sent&template_ids=[${templateIds.join(',')}]`;
        const response = await fetch(analyticsUrl, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            },
            mode: 'cors'
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
        }

        const data = await response.json();
        analyticsData = data.data || [];
        updateAnalyticsDateRangeDisplay(finalStartDate, finalEndDate);
        displayAnalytics(analyticsData);
    } catch (error) {
        console.error('Error fetching analytics:', error);
        if (error.message === 'Failed to fetch') {
            displayBasicAnalytics();
        } else {
            analyticsDiv.innerHTML = `<div class="error">Error loading analytics: ${error.message}. Falling back to last 7 days.</div>`;
            // Fallback to last 7 days
            setAnalyticsDateRange('last-7-days');
        }
    }
}

            // Toggle custom date range input visibility for analytics
            document.querySelectorAll('input[name="analytics-date-range"]').forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        document.getElementById('customAnalyticsDateRange').style.display = 'flex';
                    } else {
                        document.getElementById('customAnalyticsDateRange').style.display = 'none';
                        setAnalyticsDateRange(this.value);
                    }
                });
            });

            // Set default date range to "Last 7 days" for analytics
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelector('input[name="analytics-date-range"][value="last-7-days"]').checked = true;
                setAnalyticsDateRange('last-7-days');
            });

       function applyCustomDateRange() {
    const startDateInput = document.getElementById('startDate').value;
    const endDateInput = document.getElementById('endDate').value;

    if (!validateDateRange(startDateInput, endDateInput)) {
        return;
    }

    const startDate = new Date(startDateInput).getTime() / 1000;
    const endDate = new Date(endDateInput).getTime() / 1000;

    fetchBilling(startDate, endDate);
}


            // Update date range display for billing
            function updateDateRangeDisplay(startDate, endDate) {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                const startDateStr = new Date(startDate * 1000).toLocaleDateString(undefined, options);
                const endDateStr = new Date(endDate * 1000).toLocaleDateString(undefined, options);
                document.getElementById('dateRangeDisplay').textContent = `${startDateStr} - ${endDateStr}`;
            }

            // Toggle custom date range input visibility for billing
            document.querySelectorAll('input[name="date-range"]').forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        document.getElementById('customDateRange').style.display = 'flex';
                    } else {
                        document.getElementById('customDateRange').style.display = 'none';
                        setDateRange(this.value);
                    }
                });
            });

            // Set default date range to "Last 7 days" for billing
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelector('input[name="date-range"][value="last-7-days"]').checked = true;
                setDateRange('last-7-days');
            });

            // Display Analytics
            function displayAnalytics(analytics) {
                const analyticsDiv = document.getElementById('analyticsResult');
                if (analytics.length === 0 || !analytics[0] || !analytics[0].data_points || analytics[0].data_points.length === 0) {
                    displayBasicAnalytics();
                    return;
                }
                // Process analytics data
                const templateStats = {};
                let totalSent = 0, totalDelivered = 0, totalRead = 0;
                analytics[0].data_points.forEach(point => {
                    const templateId = point.template_id;
                    const templateInfo = templatesData.find(t => t.id === templateId);
                    const templateName = templateInfo ? templateInfo.name : `Template ${templateId}`;
                    if (!templateStats[templateId]) {
                        templateStats[templateId] = {
                            name: templateName,
                            language: templateInfo ? templateInfo.language : 'N/A',
                            status: templateInfo ? templateInfo.status : 'N/A',
                            sent: 0,
                            delivered: 0,
                            read: 0,
                            clicked: 0
                        };
                    }
                    templateStats[templateId].sent += point.sent || 0;
                    templateStats[templateId].delivered += point.delivered || 0;
                    templateStats[templateId].read += point.read || 0;
                    templateStats[templateId].clicked += point.clicked || 0;
                    totalSent += point.sent || 0;
                    totalDelivered += point.delivered || 0;
                    totalRead += point.read || 0;
                });
                // Update analytics cards
                document.getElementById('totalSent').textContent = totalSent;
                document.getElementById('totalDelivered').textContent = totalDelivered;
                const readRate = totalDelivered > 0 ? ((totalRead / totalDelivered) * 100).toFixed(1) : 0;
                document.getElementById('readRate').textContent = readRate + '%';
                // Display template analytics table
                let tableHTML = `
                    <div class="table-scroll-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Template Name</th>
                                    <th>Language</th>
                                    <th>Status</th>
                                    <th>Messages Sent</th>
                                    <th>Delivered</th>
                                    <th>Read</th>
                                    <th>Delivery Rate</th>
                                    <th>Read Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                Object.values(templateStats).forEach(stat => {
                    const deliveryRate = stat.sent > 0 ? ((stat.delivered / stat.sent) * 100).toFixed(1) : 0;
                    const readRate = stat.delivered > 0 ? ((stat.read / stat.delivered) * 100).toFixed(1) : 0;
                    tableHTML += `
                        <tr>
                            <td><strong>${stat.name}</strong></td>
                            <td>${stat.language}</td>
                            <td><span class="status-badge status-${stat.status.toLowerCase()}">${stat.status}</span></td>
                            <td>${stat.sent}</td>
                            <td>${stat.delivered}</td>
                            <td>${stat.read}</td>
                            <td>${deliveryRate}%</td>
                            <td>${readRate}%</td>
                        </tr>
                    `;
                });
                tableHTML += '</tbody></table>';
                analyticsDiv.innerHTML = tableHTML;
            }

            // CORS Error Handler
            function showCORSError() {
                const corsError = `
                    <div class="error" style="max-width: none;">
                        <h4>CORS Error - Direct API Access Blocked</h4>
                        <p><strong>The browser is blocking direct API calls to Facebook Graph API due to CORS policy.</strong></p>
                        <h5>Solutions:</h5>
                        <ol>
                            <li><strong>Backend Proxy (Recommended):</strong> Create a backend endpoint that proxies requests to Facebook Graph API</li>
                            <li><strong>CORS Proxy Service:</strong> Use a CORS proxy like <code>https://cors-anywhere.herokuapp.com/</code></li>
                            <li><strong>Browser Extension:</strong> Install a CORS extension for development</li>
                            <li><strong>Postman/Insomnia:</strong> Use these tools for API testing (they don't have CORS restrictions)</li>
                        </ol>
                        <p><strong>For production use, implement a server-side proxy to handle API calls!</strong></p>
                    </div>
                `;
                const contentArea = document.querySelector('.content-area');
                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = corsError;
                contentArea.insertBefore(errorDiv, contentArea.firstChild);
                setTimeout(() => {
                    errorDiv.remove();
                }, 15000);
            }
		function validateDateRange(startDate, endDate) {
    if (!startDate || !endDate) {
        showError("Please select both start and end dates.");
        return false;
    }
    if (new Date(startDate) > new Date(endDate)) {
        showError("Enter a valid date range. 'To Date' cannot be less than 'From Date'.");
        return false;
    }
    return true;
}
	

            // Utility functions for showing messages
            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = message;
                const contentArea = document.querySelector('.content-area');
                contentArea.insertBefore(errorDiv, contentArea.firstChild);
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
			function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error';
    errorDiv.innerHTML = message;
    const contentArea = document.querySelector('.content-area');
    contentArea.insertBefore(errorDiv, contentArea.firstChild);
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}


            function showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.innerHTML = message;
                const contentArea = document.querySelector('.content-area');
                contentArea.insertBefore(successDiv, contentArea.firstChild);
                setTimeout(() => {
                    successDiv.remove();
                }, 5000);
            }

            // Add some utility functions for future enhancements
            function exportTemplateData() {
                if (templatesData.length === 0) {
                    showError('No template data available to export');
                    return;
                }
                const csvContent = "data:text/csv;charset=utf-8,"
                    + "Template Name,Language,Status,Category,Template ID,Components,Created Date\n"
                    + templatesData.map(template => {
                        const componentTypes = template.components ? template.components.map(c => c.type).join('; ') : 'N/A';
                        const createdDate = template.created_time ? new Date(template.created_time * 1000).toLocaleDateString() : 'N/A';
                        return `"${template.name}","${template.language}","${template.status}","${template.category}","${template.id}","${componentTypes}","${createdDate}"`;
                    }).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "whatsapp_templates_" + new Date().toISOString().split('T')[0] + ".csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSuccess('Template data exported successfully!');
            }
 
    </script>
</body>

</html>
